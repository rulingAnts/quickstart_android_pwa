<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2196F3">
    <meta name="description" content="Comparative Wordlist Elicitation Tool for linguistic fieldwork">
    
    <title>Wordlist Elicitation Tool</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icons/icon-192.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Unsupported Browser Screen -->
    <div id="unsupported" class="screen" style="display:none;min-height:100vh;align-items:center;justify-content:center;text-align:center;padding:24px;">
        <div>
            <h1 style="margin-bottom:12px;">Unsupported Browser</h1>
            <p style="margin:0 0 8px;">This app requires microphone access, MediaRecorder, Web Audio, and 16â€‘bit WAV support.</p>
            <p style="margin:0 0 16px;">Please use a recent version of Chrome, Edge, or Android WebView (or Chrome on Android).</p>
            <div id="unsupported-reason" style="color:#d32f2f; font-weight:600; margin-bottom:16px;"></div>
            <button id="recheck-btn" class="main-button" style="display:inline-flex;align-items:center;gap:8px;">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" aria-hidden="true"><path d="M12 6V3L8 7l4 4V8c2.76 0 5 2.24 5 5 0 1.01-.3 1.95-.82 2.74l1.46 1.46A7.93 7.93 0 0 0 20 13c0-4.42-3.58-8-8-8zm-5.18.26A7.93 7.93 0 0 0 4 11c0 4.42 3.58 8 8 8v3l4-4-4-4v3c-2.76 0-5-2.24-5-5 0-1.01.3-1.95.82-2.74L6.54 6.26z"/></svg>
                Re-check capabilities
            </button>
        </div>
    </div>

    <div id="app">
        <!-- Home Screen -->
        <div id="home-screen" class="screen active">
            <header class="app-header">
                <h1>Wordlist Elicitation Tool</h1>
            </header>
            
            <main class="main-content">
                <div class="hero-icon">
                    <svg viewBox="0 0 24 24" width="80" height="80" fill="currentColor">
                        <path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/>
                    </svg>
                </div>
                
                <h2 class="app-title">Comparative Wordlist<br>Elicitation Tool</h2>
                
                <div class="progress-card">
                    <h3>Progress</h3>
                    <div class="stats-container">
                        <div class="stat-item">
                            <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
                                <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
                            </svg>
                            <div class="stat-value" id="total-count">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-item">
                            <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            <div class="stat-value" id="completed-count">0</div>
                            <div class="stat-label">Completed</div>
                        </div>
                        <div class="stat-item">
                            <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                <circle cx="12" cy="12" r="8" fill="none" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            <div class="stat-value" id="remaining-count">0</div>
                            <div class="stat-label">Remaining</div>
                        </div>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="main-button" id="import-btn" data-nav="import-screen">
                        <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
                            <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/>
                        </svg>
                        <span>Import Wordlist</span>
                    </button>
                    
                    <button class="main-button" id="elicitation-btn" disabled>
                        <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
                            <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
                        </svg>
                        <span>Start Elicitation</span>
                    </button>
                    
                    <button class="main-button" id="export-btn" disabled>
                        <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
                            <path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/>
                        </svg>
                        <span>Export Data</span>
                    </button>
                </div>
            </main>
        </div>
        
        <!-- Import Screen -->
        <div id="import-screen" class="screen">
            <header class="app-header">
                <button class="back-button" id="import-back-btn">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                    </svg>
                </button>
                <h1>Import Wordlist</h1>
            </header>
            
            <main class="main-content">
                <div class="import-container">
                    <div class="info-box">
                        <p>Select a Dekereke XML wordlist file to import.</p>
                        <p>The file should contain reference numbers, glosses, and optional picture references.</p>
                    </div>
                    
                    <input type="file" id="file-input" accept=".xml" style="display: none;">
                    <button class="main-button" id="select-file-btn">
                        <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
                            <path d="M6 2c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6H6zm7 7V3.5L18.5 9H13z"/>
                        </svg>
                        <span>Select XML File</span>
                    </button>

                    <div style="margin:16px 0; text-align:center; color:#666;">or</div>

                    <div class="online-import">
                        <label for="online-source-select" style="display:block; margin-bottom:8px; font-weight:600;">Import from Online Source</label>
                        <select id="online-source-select" class="select-input" style="width:100%; margin-bottom:12px;">
                            <option value="https://raw.githubusercontent.com/rulingAnts/QWOM_Data/refs/heads/main/QWOM2025-08.xml">
                                Quickstart Wordlist of Melanesia (QWOM)
                            </option>
                        </select>
                        <button class="main-button" id="import-online-btn">
                            <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor" aria-hidden="true">
                                <path d="M19 19H5v-2h14v2zM13 5.83V15h-2V5.83L7.41 9.41 6 8l6-6 6 6-1.41 1.41L13 5.83z"/>
                            </svg>
                            <span>Import Selected Source</span>
                        </button>
                        <p style="color:#666; font-size:0.9em; margin-top:8px;">Note: This replaces any existing wordlist in local storage.</p>
                    </div>
                    
                    <div id="import-status" class="status-message"></div>
                </div>
            </main>
        </div>
        
        <!-- Elicitation Screen -->
        <div id="elicitation-screen" class="screen">
            <header class="app-header">
                <button class="back-button" id="elicitation-back-btn">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                    </svg>
                </button>
                <h1>Elicitation</h1>
                <button class="back-button" id="entry-list-btn" title="All entries" aria-label="All entries">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M4 6h16v2H4V6zm0 5h16v2H4v-2zm0 5h16v2H4v-2z"/>
                    </svg>
                </button>
            </header>
            
            <main class="main-content elicitation-content">
                <!-- Slide-out entry list panel -->
                <div id="entry-list-panel" style="display:none; position:fixed; top:0; right:0; bottom:0; width:320px; max-width:85vw; background:#fff; box-shadow:-4px 0 16px rgba(0,0,0,.2); z-index:1000;">
                    <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 12px; border-bottom:1px solid #eee;">
                        <strong>All Entries</strong>
                        <button id="entry-list-close" class="back-button" aria-label="Close entries list">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                        </button>
                    </div>
                    <div style="padding:8px 8px 80px 8px; overflow:auto; height:calc(100% - 48px);">
                        <ul id="entry-list" style="list-style:none; margin:0; padding:0;">
                            <!-- populated dynamically -->
                        </ul>
                    </div>
                </div>
                <div id="entry-list-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.25); z-index:999;"></div>

                <div class="word-card">
                    <div class="word-reference" id="word-reference">0001</div>
                    <div class="word-gloss" id="word-gloss">body</div>
                    
                    <div class="picture-container" id="picture-container" style="display: none;">
                        <img id="word-picture" alt="Word illustration">
                    </div>
                    
                    <div class="transcription-container">
                        <label for="transcription-input">Local Transcription:</label>
                        <input type="text" id="transcription-input" class="transcription-input" placeholder="Enter transcription...">
                    </div>
                    
                    <div class="recording-container">
                        <button class="record-button" id="record-btn">
                            <svg viewBox="0 0 24 24" width="48" height="48" fill="currentColor">
                                <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                                <path d="M17.3 11c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
                            </svg>
                            <span id="record-text">Record</span>
                        </button>
                        
                        <button class="play-button" id="play-btn" style="display: none;">
                            <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                            <span>Play</span>
                        </button>
                    </div>
                    
                    <div id="recording-status" class="status-message"></div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="nav-button" id="prev-btn">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                        </svg>
                        <span>Previous</span>
                    </button>
                    
                    <span class="word-counter" id="word-counter">1 / 200</span>
                    
                    <button class="nav-button" id="next-btn">
                        <span>Next</span>
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                        </svg>
                    </button>
                </div>
            </main>
        </div>
        
        <!-- Export Screen -->
        <div id="export-screen" class="screen">
            <header class="app-header">
                <button class="back-button" id="export-back-btn">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                    </svg>
                </button>
                <h1>Export Data</h1>
            </header>
            
            <main class="main-content">
                <div class="export-container">
                    <div class="info-box">
                        <p>Export all collected data as a ZIP archive containing:</p>
                        <ul>
                            <li>Dekereke XML file with transcriptions</li>
                            <li>Audio recordings (WAV format)</li>
                            <li>Consent log</li>
                        </ul>
                    </div>
                    
                    <div class="export-stats">
                        <div class="stat-row">
                            <span>Total Entries:</span>
                            <span id="export-total">0</span>
                        </div>
                        <div class="stat-row">
                            <span>Completed:</span>
                            <span id="export-completed">0</span>
                        </div>
                        <div class="stat-row">
                            <span>With Audio:</span>
                            <span id="export-audio">0</span>
                        </div>
                    </div>
                    
                    <button class="main-button" id="export-data-btn">
                        <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
                            <path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/>
                        </svg>
                        <span>Export ZIP Archive</span>
                    </button>
                    
                    <div id="export-status" class="status-message"></div>
                </div>
            </main>
        </div>
    </div>
    
    <script src="js/logger.js"></script>
    <script src="js/capability-check.js"></script>
    <script>
        function showUnsupported(reasonText) {
            const app = document.getElementById('app');
            if (app) app.style.display = 'none';
            const u = document.getElementById('unsupported');
            if (u) u.style.display = 'flex';
            const r = document.getElementById('unsupported-reason');
            if (r) r.textContent = reasonText ? `Reason: ${reasonText}` : '';
        }

        function loadScriptsSequential(urls, done) {
            let i = 0;
            const next = () => {
                if (i >= urls.length) {
                    if (typeof done === 'function') done();
                    return;
                }
                const s = document.createElement('script');
                s.src = urls[i++];
                s.onload = next;
                s.onerror = () => {
                    Log.e('Failed to load script', s.src);
                    showUnsupported();
                };
                document.body.appendChild(s);
            };
            next();
        }

        (async function init() {
            try {
                const res = await (window.CapabilityCheck && window.CapabilityCheck.checkWithCache ? window.CapabilityCheck.checkWithCache() : { ok:false, reason:'capability module missing' });
                Log.i('Capability check result', res);
                if (!res.ok) {
                    Log.w('Unsupported environment', res.reason);
                    showUnsupported(res.reason);
                    return;
                }
            } catch (e) {
                Log.e('Capability check failed', e);
                showUnsupported();
                return;
            }

            const scripts = [
                'js/storage.js',
                'js/xml-parser.js',
                'js/audio-recorder.js',
                'js/export.js',
                'js/app.js'
            ];
            loadScriptsSequential(scripts, function () {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('service-worker.js')
                        .then(() => {
                            Log.i('Service Worker registered');
                            // After registration, wire the update checker
                            const s = document.createElement('script');
                            s.src = 'js/update-check.js';
                            s.onload = () => Log.d && Log.d('Update checker loaded');
                            s.onerror = () => Log.w && Log.w('Update checker failed to load');
                            document.body.appendChild(s);
                        })
                        .catch((error) => Log.e('Service Worker registration failed', error));
                }
            });
        })();
                // Re-check button wiring
                (function wireRecheck(){
                    const btn = document.getElementById('recheck-btn');
                    if (!btn) return;
                    btn.addEventListener('click', async () => {
                        try {
                            if (window.CapabilityCheck && window.CapabilityCheck.clearCache) {
                                window.CapabilityCheck.clearCache();
                            }
                            Log.i('Re-running capability checks');
                            // Force a fresh page load to re-run checks and ensure modules init cleanly
                            window.location.reload();
                        } catch (e){
                            Log.e('Re-check failed', e);
                        }
                    });
                })();
    </script>
</body>
</html>
